# ==========================================================
# STACK: n8n + Evolution API + Supabase (Postgres externo) + Key Value (Redis-compatível)
# Ambiente: Render Free Tier (otimizado)
# Repo: globozeca/render_n8n
# ==========================================================

services:
  # =============== Evolution API (Web) ===============
  - type: web
    name: evolution-api
    runtime: docker
    plan: free
    region: oregon
    dockerfilePath: ./evolution-api/Dockerfile
    buildCommand: echo "Building Evolution API..."
    autoDeploy: true
    envVars:
      - key: PORT
        value: "3000"
      - key: NODE_ENV
        value: production

      # Postgres externo (Supabase) - preencha no painel:
      # Ex.: postgres://USER:PASSWORD@HOST:5432/DBNAME?sslmode=require
      - key: DATABASE_URL
        sync: false

      # Key Value (Valkey/Redis-compatível) interno da Render
      - key: REDIS_URL
        fromService:
          type: keyvalue
          name: redis
          property: connectionString

      # Supabase (se a Evolution API consome REST/Storage/Auth)
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_KEY
        sync: false

      # Outras chaves/filtros
      - key: API_KEY
        sync: false
      - key: ALLOWED_ORIGINS
        value: "*"

  # =================== n8n (Web) ===================
  - type: web
    name: n8n
    runtime: image
    image:
      url: docker.io/n8nio/n8n:latest
      # Dica: para estabilidade, fixe a versão (ex.: 1.102.3).
      # url: docker.io/n8nio/n8n:1.102.3
    plan: free
    region: oregon
    autoDeploy: true
    healthCheckPath: /healthz
    envVars:
      # Porta exposta
      - key: PORT
        value: "5678"

      # URL pública (ajuste se usar domínio próprio)
      - key: WEBHOOK_URL
        sync: false

      # Segurança / autenticação (preencha no painel)
      - key: N8N_ENCRYPTION_KEY
        sync: false
      - key: NODE_ENV
        value: production
      - key: N8N_BASIC_AUTH_ACTIVE
        value: "true"
      - key: N8N_BASIC_AUTH_USER
        sync: false
      - key: N8N_BASIC_AUTH_PASSWORD
        sync: false

      # Banco: Supabase (Postgres externo)
      - key: DB_TYPE
        value: postgresdb
      - key: DB_POSTGRESDB_HOST
        sync: false            # ex.: db.xxxxx.supabase.co (ou host do pooler)
      - key: DB_POSTGRESDB_PORT
        value: "5432"
      - key: DB_POSTGRESDB_DATABASE
        sync: false
      - key: DB_POSTGRESDB_USER
        sync: false
      - key: DB_POSTGRESDB_PASSWORD
        sync: false
      # Supabase geralmente exige SSL:
      - key: DB_POSTGRESDB_SSL_ENABLED
        value: "true"
      - key: DB_POSTGRESDB_SSL_REJECT_UNAUTHORIZED
        value: "true"

      # Redis (fila/cache) – Key Value interno
      # Para usar fila do n8n, ative também EXECUTIONS_MODE=queue (ver README/observação).
      - key: QUEUE_BULL_REDIS_HOST
        fromService:
          type: keyvalue
          name: redis
          property: host
      - key: QUEUE_BULL_REDIS_PORT
        fromService:
          type: keyvalue
          name: redis
          property: port

      # Fuso horário
      - key: GENERIC_TIMEZONE
        value: Africa/Luanda

      # Integrações usadas pelos seus fluxos (preencher no painel)
      - key: EVOLUTION_API_URL
        sync: false
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_KEY
        sync: false
      - key: OPENAI_API_KEY
        sync: false

  # =============== Key Value (Valkey/Redis-compatível) ===============
  - type: keyvalue
    name: redis
    plan: free
    region: oregon
    ipAllowList: []            # apenas tráfego interno da Render
    # Para filas, 'noeviction' evita descarte de jobs quando a memória enche
    maxmemoryPolicy: noeviction
