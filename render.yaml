# ==========================================================
# STACK: n8n + Evolution API + Supabase + Redis (Render Free)
# Repo: globozeca/render_n8n
# ==========================================================

services:

  # ========================================================
  # Evolution API
  # ========================================================
  - type: web
    name: evolution-api
    runtime: docker
    plan: free
    region: oregon
    dockerfilePath: ./evolution-api/Dockerfile
    autoDeploy: true
    healthCheckPath: /health

    envVars:
      - key: PORT
        value: "3000"
      - key: NODE_ENV
        value: production

      # Banco: Supabase (preencher no painel)
      - key: DATABASE_URL
        sync: false

      # Redis interno
      - key: REDIS_URL
        fromService:
          type: keyvalue
          name: redis
          property: connectionString

      # Segurança da Evolution API
      - key: JWT_SECRET
        sync: false
      - key: ADMIN_TOKEN
        sync: false

      # Supabase REST (se usar Storage/Auth)
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_KEY
        sync: false

      # CORS
      - key: ALLOWED_ORIGINS
        value: "*"

  # ========================================================
  # n8n
  # ========================================================
  - type: web
    name: n8n
    runtime: image
    image:
      url: docker.io/n8nio/n8n:latest
    plan: free
    region: oregon
    healthCheckPath: /healthz
    autoDeploy: true

    envVars:

      # Porta
      - key: PORT
        value: "5678"

      # URL pública
      - key: WEBHOOK_URL
        sync: false

      # Autenticação
      - key: N8N_BASIC_AUTH_ACTIVE
        value: "true"
      - key: N8N_BASIC_AUTH_USER
        sync: false
      - key: N8N_BASIC_AUTH_PASSWORD
        sync: false

      - key: N8N_ENCRYPTION_KEY
        sync: false

      - key: NODE_ENV
        value: production

      # Otimização de memória (Render Free)
      - key: NODE_OPTIONS
        value: "--max-old-space-size=320"
      - key: N8N_RUNNERS_ENABLED
        value: "true"

      - key: GENERIC_TIMEZONE
        value: Africa/Luanda

      # Banco — Supabase Pooler
      - key: DB_TYPE
        value: postgresdb
      - key: DB_POSTGRESDB_HOST
        sync: false
      - key: DB_POSTGRESDB_PORT
        value: "5432"
      - key: DB_POSTGRESDB_DATABASE
        sync: false
      - key: DB_POSTGRESDB_USER
        sync: false
      - key: DB_POSTGRESDB_PASSWORD
        sync: false
      - key: DB_POSTGRESDB_SSL_ENABLED
        value: "true"
      - key: DB_POSTGRESDB_SSL_REJECT_UNAUTHORIZED
        value: "false"

      # Redis — ENQUANTO NÃO ATIVARES MODO FILA
      - key: QUEUE_BULL_REDIS_HOST
        fromService:
          type: keyvalue
          name: redis
          property: host
      - key: QUEUE_BULL_REDIS_PORT
        fromService:
          type: keyvalue
          name: redis
          property: port

      # Integrações
      - key: EVOLUTION_API_URL
        sync: false
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_KEY
        sync: false
      - key: OPENAI_API_KEY
        sync: false

  # ========================================================
  # Redis interno (KeyValue)
  # ========================================================
  - type: keyvalue
    name: redis
    plan: free
    region: oregon
    ipAllowList: []
    maxmemoryPolicy: noeviction
