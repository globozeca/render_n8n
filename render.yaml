# ==========================================================
# STACK: n8n + Evolution API + Supabase (Postgres externo) + Key Value (Redis-compatível)
# Ambiente: Render Free Tier (otimizado)
# Repo: globozeca/render_n8n
# ==========================================================

services:
  # =============== Evolution API (Web) ===============
  - type: web
    name: evolution-api
    # Se você tem Dockerfile próprio, mantenha 'env: docker' e 'dockerfilePath'.
    # Caso contrário, troque para 'runtime: image' + image.url.
    env: docker
    plan: free
    region: oregon
    dockerfilePath: ./evolution-api/Dockerfile
    buildCommand: echo "Building Evolution API..."
    autoDeploy: true
    envVars:
      - key: PORT
        value: "3000"
      - key: NODE_ENV
        value: production

      # Postgres externo (Supabase) - preencha no painel:
      - key: DATABASE_URL              # ex.: postgres://user:pass@host:5432/dbname?sslmode=require
        sync: false

      # Redis/Key Value interno da Render (Valkey)
      - key: REDIS_URL
        fromService:
          type: keyvalue
          name: redis
          property: connectionString

      # Supabase (se a Evolution API também consome REST/Storage/Auth do Supabase)
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_KEY
        sync: false

      # Outras chaves/filtros
      - key: API_KEY
        sync: false
      - key: ALLOWED_ORIGINS
        value: "*"

  # =================== n8n (Web) ===================
  - type: web
    name: n8n
    # Recomendada a imagem oficial. Se você tem Dockerfile próprio, mantenha env: docker.
    # Abaixo, usando imagem oficial para simplificar o free tier:
    runtime: image
    image:
      url: docker.io/n8nio/n8n:latest
      # Dica: para estabilidade, fixe a versão (ex.: 1.102.3) em vez de 'latest'.
      # url: docker.io/n8nio/n8n:1.102.3
    plan: free
    region: oregon
    autoDeploy: true
    envVars:
      # Porta exposta
      - key: PORT
        value: "5678"

      # URL pública (ajuste se usar domínio próprio)
      - key: WEBHOOK_URL
        sync: false

      # Segurança / autenticação (preencha no painel)
      - key: N8N_ENCRYPTION_KEY
        sync: false
      - key: NODE_ENV
        value: production
      - key: N8N_BASIC_AUTH_ACTIVE
        value: "true"
      - key: N8N_BASIC_AUTH_USER
        sync: false
      - key: N8N_BASIC_AUTH_PASSWORD
        sync: false

      # Banco: Supabase (Postgres externo)
      - key: DB_TYPE
        value: postgresdb
      - key: DB_POSTGRESDB_HOST
        sync: false            # ex.: db.xxxxx.supabase.co (ou host do pooler)
      - key: DB_POSTGRESDB_PORT
        value: "5432"
      - key: DB_POSTGRESDB_DATABASE
        sync: false
      - key: DB_POSTGRESDB_USER
        sync: false
      - key: DB_POSTGRESDB_PASSWORD
        sync: false
      # Se o seu projeto exigir SSL (Supabase geralmente exige):
      - key: DB_POSTGRESDB_SSL_ENABLED
        value: "true"
      - key: DB_POSTGRESDB_SSL_REJECT_UNAUTHORIZED
        value: "true"

      # Redis (fila/cache) - apontando para Key Value interno
      # Para usar fila do n8n ative também EXECUTIONS_MODE=queue (veja README):
      # - key: EXECUTIONS_MODE
      #   value: queue
      - key: QUEUE_BULL_REDIS_HOST
        fromService:
          type: keyvalue
          name: redis
          property: host
      - key: QUEUE_BULL_REDIS_PORT
        fromService:
          type: keyvalue
          name: redis
          property: port

      # Fuso horário
      - key: GENERIC_TIMEZONE
        value: Africa/Luanda

      # Integrações usadas pelos seus fluxos (preencha no painel)
      - key: EVOLUTION_API_URL
        sync: false
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_KEY
        sync: false
      - key: OPENAI_API_KEY
        sync: false

    healthCheckPath: /healthz

  # =============== Key Value (Valkey/Redis-compatível) ===============
  - type: keyvalue
    name: redis
    plan: free
    region: oregon
    ipAllowList: []            # apenas tráfego interno da Render
    # Para filas, 'noeviction' evita descarte de jobs quando estoura memória
    maxmemoryPolicy: noeviction
    previews:
      generation: off
